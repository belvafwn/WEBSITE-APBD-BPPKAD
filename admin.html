<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - BPPKAD Blora</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div id="loginSection" class="login-container">
        <div class="login-box">
            <img src="assets/logo.png" alt="Logo BPPKAD" class="logo-login">
            <h2>Login Admin</h2>
            <p>BPPKAD Kabupaten Blora</p>
            <form onsubmit="return login(event)">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn-primary">Masuk</button>
                <div id="loginError" class="error-message"></div>
            </form>
            <a href="index.html" class="back-link">Kembali ke Beranda</a>
        </div>
    </div>

    <div id="adminPanel" class="admin-panel" style="display: none;">
        <header>
            <div class="container">
                <div class="header-content">
                    <img src="assets/logo.png" alt="Logo BPPKAD" class="logo">
                    <div class="header-text">
                        <h1>Admin Panel - BPPKAD Blora</h1>
                        <p>Manajemen Data Realisasi APBD</p>
                    </div>
                </div>
                <button onclick="logout()" class="btn-logout">Logout</button>
            </div>
        </header>

        <main class="container">
            <section class="admin-section">
                <h2>Tambah Data Baru</h2>
                <form id="addDataForm" onsubmit="return addData(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="kategori">Kategori</label>
                            <select id="kategori" required>
                                <option value="">Pilih Kategori</option>
                                <option value="Pendapatan">Pendapatan</option>
                                <option value="Pembelanjaan">Pembelanjaan</option>
                                <option value="Pembiayaan">Pembiayaan</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="subkategori">Subkategori</label>
                            <input type="text" id="subkategori" placeholder="Masukkan subkategori" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="tahun">Tahun</label>
                            <input type="number" id="tahun" placeholder="2025" min="2000" max="2100" required>
                        </div>
                        <div class="form-group">
                            <label for="nilai">Nilai (Rp)</label>
                            <input type="number" id="nilai" placeholder="1000000000" step="0.01" required>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary">Tambah Data</button>
                    <div id="addMessage" class="message"></div>
                </form>
            </section>

            <section class="admin-section">
                <h2>Data yang Ada</h2>
                <div class="search-box">
                    <input type="text" id="adminSearchInput" placeholder="Cari data...">
                    <button onclick="searchAdminData()">Cari</button>
                </div>
                <div id="adminDataTable" class="data-table-container"></div>
            </section>
        </main>

        <footer>
            <div class="container">
                <p>&copy; 2025 BPPKAD Kabupaten Blora. Semua hak dilindungi.</p>
            </div>
        </footer>
    </div>

    <script src="js/supabase.js"></script>
    <script>
        function login(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');

            if (username === 'admin123' && password === '123Admin') {
                sessionStorage.setItem('adminLoggedIn', 'true');
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                loadAdminData();
            } else {
                errorDiv.textContent = 'Username atau password salah!';
                errorDiv.style.display = 'block';
            }
            return false;
        }

        function logout() {
            sessionStorage.removeItem('adminLoggedIn');
            document.getElementById('loginSection').style.display = 'flex';
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        async function addData(event) {
            event.preventDefault();
            const messageDiv = document.getElementById('addMessage');
            
            const data = {
                kategori: document.getElementById('kategori').value,
                subkategori: document.getElementById('subkategori').value,
                tahun: parseInt(document.getElementById('tahun').value),
                nilai: parseFloat(document.getElementById('nilai').value)
            };

            try {
                const { error } = await supabase
                    .from('apbd_data')
                    .insert([data]);

                if (error) throw error;

                messageDiv.textContent = 'Data berhasil ditambahkan!';
                messageDiv.className = 'message success';
                messageDiv.style.display = 'block';
                document.getElementById('addDataForm').reset();
                loadAdminData();

                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 3000);
            } catch (error) {
                messageDiv.textContent = 'Error: ' + error.message;
                messageDiv.className = 'message error';
                messageDiv.style.display = 'block';
            }
            return false;
        }

        async function deleteData(id) {
            if (!confirm('Apakah Anda yakin ingin menghapus data ini?')) return;

            try {
                const { error } = await supabase
                    .from('apbd_data')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                alert('Data berhasil dihapus!');
                loadAdminData();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function loadAdminData() {
            try {
                const { data, error } = await supabase
                    .from('apbd_data')
                    .select('*')
                    .order('tahun', { ascending: false });

                if (error) throw error;

                displayAdminData(data);
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        function displayAdminData(data) {
            const tableDiv = document.getElementById('adminDataTable');
            
            if (!data || data.length === 0) {
                tableDiv.innerHTML = '<p class="no-data">Belum ada data. Silakan tambahkan data baru.</p>';
                return;
            }

            let html = '<table><thead><tr><th>Kategori</th><th>Subkategori</th><th>Tahun</th><th>Nilai (Rp)</th><th>Aksi</th></tr></thead><tbody>';
            
            data.forEach(item => {
                html += `<tr>
                    <td>${item.kategori}</td>
                    <td>${item.subkategori}</td>
                    <td>${item.tahun}</td>
                    <td>${formatRupiah(item.nilai)}</td>
                    <td><button onclick="deleteData(${item.id})" class="btn-delete">Hapus</button></td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            tableDiv.innerHTML = html;
        }

        function searchAdminData() {
            const searchTerm = document.getElementById('adminSearchInput').value.toLowerCase();
            loadAdminData().then(() => {
                const rows = document.querySelectorAll('#adminDataTable tbody tr');
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            });
        }

        function formatRupiah(angka) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(angka);
        }

        window.onload = function() {
            if (sessionStorage.getItem('adminLoggedIn') === 'true') {
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                loadAdminData();
            }
        };
    </script>
</body>
</html>
